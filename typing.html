<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üéÆ „Çø„Ç§„Éî„É≥„Ç∞„Ç≠„ÉÉ„Ç∫</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#fff5f5;--accent:#ff6b9d}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI Emoji','Apple Color Emoji','Noto Color Emoji',system-ui,sans-serif;touch-action:manipulation}
body{background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:background .6s}
.screen{display:none;width:100%;height:100%;flex-direction:column;align-items:center;position:relative}
.screen.active{display:flex}

/* MENU */
#menu{justify-content:center;gap:clamp(16px,4vw,32px);padding:20px}
.menu-btn{border:none;border-radius:28px;padding:clamp(20px,5vw,40px) clamp(30px,8vw,60px);font-size:clamp(48px,12vw,100px);cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 8px 0 rgba(0,0,0,.12);position:relative;animation:bob 2s ease-in-out infinite}
.menu-btn:nth-child(1){background:linear-gradient(135deg,#ffe0e6,#ffc2d1);animation-delay:0s}
.menu-btn:nth-child(2){background:linear-gradient(135deg,#d4f0ff,#b8e6ff);animation-delay:.3s}
.menu-btn:nth-child(3){background:linear-gradient(135deg,#fff3d4,#ffe8a3);animation-delay:.6s}
.menu-btn:active{transform:scale(.92);box-shadow:0 4px 0 rgba(0,0,0,.12)}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}

/* GAME */
#game{justify-content:space-between;padding:10px}
#top-bar{display:flex;width:100%;justify-content:space-between;align-items:center;padding:0 12px;height:50px;z-index:10}
.icon-btn{background:none;border:none;font-size:32px;cursor:pointer;padding:8px;border-radius:50%;transition:background .2s}
.icon-btn:active{background:rgba(0,0,0,.08)}
#star-count{font-size:28px;font-weight:bold;color:#ffa500;display:flex;align-items:center;gap:4px}
#star-count .star-icon{font-size:32px;display:inline-block}

#game-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:clamp(8px,2vw,20px);width:100%;position:relative}

/* UPDATED: Image display instead of emoji */
#image-display{width:clamp(160px,35vw,300px);height:clamp(160px,35vw,300px);animation:float 2.5s ease-in-out infinite;position:relative;z-index:2;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,0.9);box-shadow:0 4px 16px rgba(0,0,0,0.1);overflow:hidden}
#main-image{width:80%;height:80%;object-fit:contain;transition:transform .3s}
#main-image.error{display:none}
#fallback-emoji{display:none;font-size:clamp(60px,15vw,100px);animation:float 2.5s ease-in-out infinite}
#fallback-emoji.show{display:block}

@keyframes float{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-10px) scale(1.03)}}

#word-display{display:flex;gap:clamp(4px,1.5vw,12px);font-size:clamp(36px,9vw,72px);font-weight:900;letter-spacing:2px;min-height:1.2em}
.letter{display:inline-block;transition:all .2s;color:#e0d0d0;position:relative}
.letter.typed{color:var(--accent);animation:popIn .3s}
.letter.current{color:#333;animation:pulse 1s infinite;transform:scale(1.15)}
@keyframes popIn{0%{transform:scale(1.5) rotate(-5deg)}50%{transform:scale(.9)}100%{transform:scale(1)}}
@keyframes pulse{0%,100%{transform:scale(1.15)}50%{transform:scale(1.3)}}

#progress-bar{width:80%;max-width:400px;height:14px;background:#f0e0e0;border-radius:7px;overflow:hidden}
#progress-fill{height:100%;background:linear-gradient(90deg,#ff9a9e,#fad0c4,#a8edea);border-radius:7px;transition:width .3s;width:0}

/* KEYBOARD */
#keyboard{width:100%;max-width:700px;padding:0 4px 10px;display:flex;flex-direction:column;gap:clamp(4px,1vw,8px);align-self:center}
.kb-row{display:flex;justify-content:center;gap:clamp(3px,.8vw,6px)}
.key{border:none;border-radius:clamp(8px,2vw,14px);font-size:clamp(18px,4.5vw,30px);font-weight:800;min-width:clamp(28px,7.5vw,52px);height:clamp(38px,9vw,56px);cursor:pointer;background:#f5eef0;color:#666;transition:all .15s;box-shadow:0 3px 0 #ddd;text-transform:uppercase;display:flex;align-items:center;justify-content:center;-webkit-user-select:none;user-select:none}
.key:active{transform:translateY(2px);box-shadow:0 1px 0 #ddd}
.key.highlight{background:var(--accent);color:#fff;box-shadow:0 3px 0 color-mix(in srgb,var(--accent),#000 25%);animation:keyPulse 1s infinite}
.key.correct-flash{background:#6fdb6f;color:#fff;animation:none}
.key.wrong-flash{animation:shake .3s}
@keyframes keyPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}

/* UPDATED: Image-based effects */
.particle{position:fixed;pointer-events:none;z-index:100;width:24px;height:24px}
.particle img{width:100%;height:100%;object-fit:contain}
.sparkle{animation:sparkleAnim .8s forwards}
@keyframes sparkleAnim{0%{opacity:1;transform:scale(0) rotate(0)}50%{opacity:1;transform:scale(1.2) rotate(180deg)}100%{opacity:0;transform:scale(0) rotate(360deg) translateY(-40px)}}

.confetti-particle{animation:confettiFall 1.5s forwards}
@keyframes confettiFall{0%{opacity:1;transform:translateY(0) rotate(0) scale(1)}100%{opacity:0;transform:translateY(100vh) rotate(720deg) scale(0.5)}}

.rain-particle{font-size:clamp(30px,8vw,50px);z-index:90;animation:particleRain 2s forwards}
@keyframes particleRain{0%{opacity:1;transform:translateY(-60px) rotate(0)}100%{opacity:0;transform:translateY(100vh) rotate(360deg)}}

.run-emoji{position:fixed;font-size:60px;z-index:90;pointer-events:none;bottom:20%}
@keyframes runAcross{0%{left:-80px;transform:scaleX(1)}49%{transform:scaleX(1)}50%{left:50%;transform:scaleX(1)}100%{left:110%;transform:scaleX(1)}}

/* UPDATED: Image-based celebration overlay */
#celebration{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:200;pointer-events:none}
#celebration.active{display:flex}
#celebration img{max-width:clamp(200px,50vw,400px);max-height:clamp(150px,35vh,300px);object-fit:contain;animation:celebBounce .6s}
#celebration .big-emoji{font-size:clamp(100px,30vw,200px);animation:celebBounce .6s}
@keyframes celebBounce{0%{transform:scale(0) rotate(-20deg)}60%{transform:scale(1.2) rotate(5deg)}100%{transform:scale(1) rotate(0)}}

/* STAR ANIMATION */
.star-fly{position:fixed;font-size:36px;z-index:300;pointer-events:none;animation:starFly 1s forwards}
@keyframes starFly{0%{opacity:1;transform:scale(2)}100%{opacity:0;transform:scale(.5) translateY(-60px)}}
#star-burst{display:inline-block}
@keyframes starBurst{0%{transform:scale(1)}50%{transform:scale(1.6) rotate(20deg)}100%{transform:scale(1)}}

/* Loading and error states */
.loading{opacity:0.7;filter:blur(2px)}
.error{opacity:0.3;filter:grayscale(1)}
</style>
</head>
<body>
<!-- MENU SCREEN -->
<div id="menu" class="screen active">
<button class="menu-btn" onclick="startGame('fruits')">üçé</button>
<button class="menu-btn" onclick="startGame('animals')">üê∂</button>
<button class="menu-btn" onclick="startGame('sounds')">üéµ</button>
</div>

<!-- GAME SCREEN -->
<div id="game" class="screen">
<div id="top-bar">
<button class="icon-btn" onclick="goMenu()">‚¨ÖÔ∏è</button>
<div id="theme-icon"></div>
<div id="star-count"><span id="star-burst" class="star-icon">‚≠ê</span><span id="star-num">0</span></div>
</div>
<div id="game-area">
<!-- UPDATED: Image display with fallback -->
<div id="image-display">
<img id="main-image" alt="" style="display:none;">
<div id="fallback-emoji"></div>
</div>
<div id="word-display"></div>
<div id="progress-bar"><div id="progress-fill"></div></div>
</div>
<div id="keyboard"></div>
<button class="icon-btn" style="position:absolute;bottom:8px;right:12px;font-size:28px" id="music-toggle" onclick="toggleMusic()">üîá</button>
</div>

<!-- UPDATED: Image-based celebration -->
<div id="celebration">
<img id="celebration-image" alt="" style="display:none;">
<div class="big-emoji"></div>
</div>

<script>
// ====== UPDATED DATA WITH IMAGE PATHS ======
const themes = {
  fruits: {
    bg: '#fff0f3',
    accent: '#ff6b9d',
    words: [
      {w:'fig',e:'üçà',img:'images/fig.png'},{w:'kiwi',e:'ü•ù',img:'images/kiwi.png'},{w:'pear',e:'üçê',img:'images/pear.png'},{w:'plum',e:'üçá',img:'images/plum.png'},
      {w:'apple',e:'üçé',img:'images/apple.png'},{w:'grape',e:'üçá',img:'images/grape.png'},{w:'peach',e:'üçë',img:'images/peach.png'},{w:'melon',e:'üçà',img:'images/melon.png'},
      {w:'lemon',e:'üçã',img:'images/lemon.png'},{w:'mango',e:'ü•≠',img:'images/mango.png'},{w:'banana',e:'üçå',img:'images/banana.png'},{w:'cherry',e:'üçí',img:'images/cherry.png'},
      {w:'orange',e:'üçä',img:'images/orange.png'},{w:'coconut',e:'ü••',img:'images/coconut.png'},{w:'strawberry',e:'üçì',img:'images/strawberry.png'}
    ],
    icon:'üçé'
  },
  animals: {
    bg: '#f0f8ff',
    accent: '#5b9bd5',
    words: [
      {w:'cat',e:'üê±',img:'images/cat.png'},{w:'dog',e:'üê∂',img:'images/dog.png'},{w:'pig',e:'üê∑',img:'images/pig.png'},{w:'cow',e:'üêÆ',img:'images/cow.png'},
      {w:'bird',e:'üê¶',img:'images/bird.png'},{w:'fish',e:'üêü',img:'images/fish.png'},{w:'bear',e:'üêª',img:'images/bear.png'},{w:'lion',e:'ü¶Å',img:'images/lion.png'},
      {w:'frog',e:'üê∏',img:'images/frog.png'},{w:'duck',e:'ü¶Ü',img:'images/duck.png'},{w:'bunny',e:'üê∞',img:'images/bunny.png'},{w:'mouse',e:'üê≠',img:'images/mouse.png'},
      {w:'horse',e:'üê¥',img:'images/horse.png'},{w:'monkey',e:'üêµ',img:'images/monkey.png'},{w:'penguin',e:'üêß',img:'images/penguin.png'}
    ],
    icon:'üê∂'
  },
  sounds: {
    bg: '#fff8e8',
    accent: '#ffa726',
    words: [
      {w:'pop',e:'üí•',img:'images/pop.png'},{w:'bam',e:'üí¢',img:'images/bam.png'},{w:'boom',e:'üí£',img:'images/boom.png'},{w:'bang',e:'üî´',img:'images/bang.png'},
      {w:'ding',e:'üîî',img:'images/ding.png'},{w:'buzz',e:'üêù',img:'images/buzz.png'},{w:'beep',e:'ü§ñ',img:'images/beep.png'},{w:'ring',e:'üìû',img:'images/ring.png'},
      {w:'zoom',e:'üèéÔ∏è',img:'images/zoom.png'},{w:'crash',e:'üí•',img:'images/crash.png'},{w:'splash',e:'üí¶',img:'images/splash.png'},{w:'clang',e:'üî®',img:'images/clang.png'},
      {w:'whoosh',e:'üå™Ô∏è',img:'images/whoosh.png'},{w:'sizzle',e:'üî•',img:'images/sizzle.png'},{w:'crackle',e:'‚ö°',img:'images/crackle.png'}
    ],
    icon:'üéµ'
  }
};

// Effect image paths
const effectImages = {
  sparkles: ['images/sparkle1.png', 'images/sparkle2.png', 'images/sparkle3.png', 'images/sparkle4.png'],
  stars: ['images/star1.png', 'images/star2.png', 'images/star3.png'],
  confetti: ['images/confetti1.png', 'images/confetti2.png', 'images/confetti3.png', 'images/confetti4.png'],
  celebration: 'images/celebration.png',
  perfect: 'images/perfect.png'
};

const kbRows = ['qwertyuiop','asdfghjkl','zxcvbnm'];

// ====== STATE ======
let currentTheme = null, currentWords = [], wordIdx = 0, charIdx = 0, stars = 0, musicOn = false, bgmOsc = null, bgmGain = null;
let audioCtx = null;
let imageCache = new Map(); // Image preloading cache

// ====== IMAGE PRELOADING ======
function preloadImage(src) {
  return new Promise((resolve, reject) => {
    if (imageCache.has(src)) {
      resolve(imageCache.get(src));
      return;
    }
    
    const img = new Image();
    img.onload = () => {
      imageCache.set(src, img);
      resolve(img);
    };
    img.onerror = () => {
      console.warn(`Failed to load image: ${src}`);
      reject(new Error(`Failed to load ${src}`));
    };
    img.src = src;
  });
}

function preloadThemeImages(themeName) {
  const theme = themes[themeName];
  const promises = theme.words.map(word => preloadImage(word.img));
  
  // Also preload effect images
  const effectPromises = [
    ...effectImages.sparkles.map(preloadImage),
    ...effectImages.stars.map(preloadImage), 
    ...effectImages.confetti.map(preloadImage),
    preloadImage(effectImages.celebration),
    preloadImage(effectImages.perfect)
  ];
  
  return Promise.allSettled([...promises, ...effectPromises]);
}

// ====== AUDIO FUNCTIONS (unchanged) ======
function getAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

stars = parseInt(localStorage.getItem('typing_kids_stars') || '0');
function saveStars() { localStorage.setItem('typing_kids_stars', stars); }
function addStar(x, y) {
  stars++;
  saveStars();
  document.getElementById('star-num').textContent = stars;
  const s = document.getElementById('star-burst');
  s.style.animation = 'none';
  s.offsetHeight;
  s.style.animation = 'starBurst .4s';
  const el = document.createElement('div');
  el.className = 'star-fly';
  el.textContent = '‚≠ê';
  el.style.left = (x||window.innerWidth/2) + 'px';
  el.style.top = (y||window.innerHeight/2) + 'px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

function playNote(freq, dur = 0.15, type = 'triangle', vol = 0.3) {
  const ctx = getAudio();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = vol;
  g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
  o.connect(g).connect(ctx.destination);
  o.start();
  o.stop(ctx.currentTime + dur);
}

function playCorrect(idx, total) {
  const baseFreq = 440;
  const scale = [0, 2, 4, 5, 7, 9, 11, 12];
  const semitone = scale[idx % scale.length] + Math.floor(idx / scale.length) * 12;
  playNote(baseFreq * Math.pow(2, semitone / 12), 0.2, 'triangle', 0.25);
}

function playWrong() { playNote(180, 0.2, 'sine', 0.1); }
function playCelebration() {
  const ctx = getAudio();
  const notes = [523, 659, 784, 1047];
  notes.forEach((f, i) => {
    setTimeout(() => playNote(f, 0.3, 'triangle', 0.2), i * 120);
  });
  setTimeout(() => playNote(1318, 0.5, 'sine', 0.15), 500);
}

function playThemeSound(theme) {
  if (theme === 'fruits') playNote(880, 0.1, 'sine', 0.2);
  else if (theme === 'animals') {
    playNote(300, 0.15, 'sawtooth', 0.1);
    setTimeout(() => playNote(400, 0.15, 'sawtooth', 0.1), 80);
  }
  else playNote(200 + Math.random() * 600, 0.3, 'square', 0.15);
}

function speakWord(word) {
  if ('speechSynthesis' in window) {
    const u = new SpeechSynthesisUtterance(word);
    u.rate = 0.8;
    u.pitch = 1.3;
    speechSynthesis.speak(u);
  }
}

function toggleMusic() {
  musicOn = !musicOn;
  document.getElementById('music-toggle').textContent = musicOn ? 'üîä' : 'üîá';
  if (musicOn) startBGM(); else stopBGM();
}
function startBGM() {
  if (bgmOsc) return;
  const ctx = getAudio();
  bgmGain = ctx.createGain();
  bgmGain.gain.value = 0.04;
  bgmGain.connect(ctx.destination);
  const melody = [262,294,330,349,392,349,330,294];
  let i = 0;
  function tick() {
    if (!musicOn) { bgmOsc = null; return; }
    const o = ctx.createOscillator();
    o.type = 'sine';
    o.frequency.value = melody[i % melody.length];
    const g = ctx.createGain();
    g.gain.value = 0.04;
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
    o.connect(g).connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.4);
    i++;
    bgmOsc = setTimeout(tick, 450);
  }
  tick();
}
function stopBGM() {
  if (bgmOsc) { clearTimeout(bgmOsc); bgmOsc = null; }
}

// ====== UPDATED: Image-based effects ======
function spawnImageParticles(x, y, images, count = 6, animationClass = 'sparkle') {
  for (let i = 0; i < count; i++) {
    const el = document.createElement('div');
    el.className = `particle ${animationClass}`;
    
    const img = document.createElement('img');
    img.src = images[Math.floor(Math.random() * images.length)];
    img.alt = '';
    el.appendChild(img);
    
    el.style.left = (x + (Math.random() - 0.5) * 80) + 'px';
    el.style.top = (y + (Math.random() - 0.5) * 80) + 'px';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 800);
  }
}

function spawnImageConfetti(count = 30) {
  for (let i = 0; i < count; i++) {
    const el = document.createElement('div');
    el.className = 'particle confetti-particle';
    
    const img = document.createElement('img');
    img.src = effectImages.confetti[Math.floor(Math.random() * effectImages.confetti.length)];
    img.alt = '';
    el.appendChild(img);
    
    el.style.left = Math.random() * 100 + 'vw';
    el.style.top = '-10px';
    el.style.width = (16 + Math.random() * 16) + 'px';
    el.style.height = (16 + Math.random() * 16) + 'px';
    el.style.animationDuration = (1 + Math.random()) + 's';
    el.style.animationDelay = (Math.random() * 0.5) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2500);
  }
}

function imageRain(imagePath, count = 8) {
  for (let i = 0; i < count; i++) {
    const el = document.createElement('div');
    el.className = 'particle rain-particle';
    
    const img = document.createElement('img');
    img.src = imagePath;
    img.alt = '';
    img.style.width = 'clamp(30px,8vw,50px)';
    img.style.height = 'clamp(30px,8vw,50px)';
    el.appendChild(img);
    
    el.style.left = (10 + Math.random() * 80) + 'vw';
    el.style.animationDelay = (Math.random() * 0.8) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2800);
  }
}

function animalRun(emoji) {
  const el = document.createElement('div');
  el.className = 'run-emoji';
  el.textContent = emoji;
  el.style.animation = 'runAcross 1.5s forwards';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1600);
}

// ====== KEYBOARD (unchanged) ======
function buildKeyboard() {
  const kb = document.getElementById('keyboard');
  kb.innerHTML = '';
  kbRows.forEach(row => {
    const div = document.createElement('div');
    div.className = 'kb-row';
    for (const ch of row) {
      const btn = document.createElement('button');
      btn.className = 'key';
      btn.textContent = ch;
      btn.dataset.key = ch;
      btn.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        handleKey(ch);
      });
      div.appendChild(btn);
    }
    kb.appendChild(div);
  });
}

function highlightKey(ch) {
  document.querySelectorAll('.key').forEach(k => {
    k.classList.toggle('highlight', k.dataset.key === ch);
  });
}

function flashKey(ch, cls) {
  const k = document.querySelector(`.key[data-key="${ch}"]`);
  if (!k) return;
  k.classList.add(cls);
  setTimeout(() => k.classList.remove(cls), 300);
}

// ====== UPDATED: Game logic with images ======
function startGame(themeName) {
  currentTheme = themeName;
  const t = themes[themeName];
  document.body.style.setProperty('--bg', t.bg);
  document.body.style.setProperty('--accent', t.accent);
  document.body.style.background = t.bg;

  currentWords = [...t.words].sort((a, b) => a.w.length - b.w.length || Math.random() - 0.5);
  wordIdx = 0;
  charIdx = 0;

  document.getElementById('menu').classList.remove('active');
  document.getElementById('game').classList.add('active');
  document.getElementById('theme-icon').textContent = t.icon;
  document.getElementById('theme-icon').style.fontSize = '32px';
  document.getElementById('star-num').textContent = stars;

  buildKeyboard();
  
  // Preload images for better performance
  preloadThemeImages(themeName).then(() => {
    console.log(`Preloaded images for ${themeName} theme`);
  });
  
  loadWord();
}

function goMenu() {
  document.getElementById('game').classList.remove('active');
  document.getElementById('menu').classList.add('active');
  document.body.style.background = '#fff5f5';
  stopBGM();
  musicOn = false;
  document.getElementById('music-toggle').textContent = 'üîá';
}

function loadWord() {
  if (wordIdx >= currentWords.length) {
    currentWords.sort(() => Math.random() - 0.5);
    wordIdx = 0;
  }
  const item = currentWords[wordIdx];
  charIdx = 0;

  // UPDATED: Load image with fallback to emoji
  const mainImg = document.getElementById('main-image');
  const fallbackEmoji = document.getElementById('fallback-emoji');
  const container = document.getElementById('image-display');
  
  container.classList.add('loading');
  mainImg.style.display = 'none';
  fallbackEmoji.classList.remove('show');
  fallbackEmoji.textContent = item.e;
  
  preloadImage(item.img)
    .then(() => {
      mainImg.src = item.img;
      mainImg.style.display = 'block';
      mainImg.classList.remove('error');
      container.classList.remove('loading');
      
      // Reset animation
      container.style.animation = 'none';
      container.offsetHeight;
      container.style.animation = 'float 2.5s ease-in-out infinite';
    })
    .catch(() => {
      // Fallback to emoji on image load failure
      mainImg.style.display = 'none';
      fallbackEmoji.classList.add('show');
      container.classList.remove('loading');
      
      // Reset animation
      container.style.animation = 'none';
      container.offsetHeight;
      container.style.animation = 'float 2.5s ease-in-out infinite';
    });

  const wd = document.getElementById('word-display');
  wd.innerHTML = '';
  for (const ch of item.w) {
    const span = document.createElement('span');
    span.className = 'letter';
    span.textContent = ch;
    wd.appendChild(span);
  }
  updateLetterStates();
  updateProgress();
  highlightKey(item.w[0]);
}

function updateLetterStates() {
  const letters = document.querySelectorAll('.letter');
  letters.forEach((l, i) => {
    l.classList.remove('typed', 'current');
    if (i < charIdx) l.classList.add('typed');
    else if (i === charIdx) l.classList.add('current');
  });
}

function updateProgress() {
  const item = currentWords[wordIdx];
  const pct = item ? (charIdx / item.w.length * 100) : 0;
  document.getElementById('progress-fill').style.width = pct + '%';
}

function handleKey(ch) {
  if (!currentTheme || wordIdx >= currentWords.length) return;
  const item = currentWords[wordIdx];
  const expected = item.w[charIdx];

  if (ch === expected) {
    // CORRECT
    charIdx++;
    playCorrect(charIdx - 1, item.w.length);
    playThemeSound(currentTheme);
    flashKey(ch, 'correct-flash');

    // UPDATED: Image-based sparkles
    const container = document.getElementById('image-display');
    const r = container.getBoundingClientRect();
    spawnImageParticles(r.left + r.width / 2, r.top + r.height / 2, effectImages.sparkles, 4);

    // Bounce animation
    const mainImg = document.getElementById('main-image');
    if (mainImg.style.display !== 'none') {
      mainImg.style.animation = 'none';
      mainImg.offsetHeight;
      mainImg.style.animation = currentTheme === 'animals' ? 'shake .3s' : 'popIn .3s';
    }

    updateLetterStates();
    updateProgress();

    if (charIdx >= item.w.length) {
      wordComplete(item);
    } else {
      highlightKey(item.w[charIdx]);
    }
  } else {
    // WRONG
    playWrong();
    flashKey(ch, 'wrong-flash');
    const container = document.getElementById('image-display');
    container.style.animation = 'none';
    container.offsetHeight;
    container.style.animation = 'shake .3s, float 2.5s ease-in-out .3s infinite';
  }
}

function wordComplete(item) {
  highlightKey('');
  playCelebration();
  spawnImageConfetti(40);

  // UPDATED: Theme-specific image effects
  if (currentTheme === 'fruits') imageRain(item.img, 10);
  else if (currentTheme === 'animals') { 
    animalRun(item.e); 
    imageRain(item.img, 5); 
  }
  else { imageRain(item.img, 12); }

  // UPDATED: Show image-based celebration
  const cel = document.getElementById('celebration');
  const celImg = document.getElementById('celebration-image');
  const celEmoji = cel.querySelector('.big-emoji');
  
  preloadImage(effectImages.celebration)
    .then(() => {
      celImg.src = effectImages.celebration;
      celImg.style.display = 'block';
      celEmoji.style.display = 'none';
    })
    .catch(() => {
      celImg.style.display = 'none';
      celEmoji.textContent = 'üéâ';
      celEmoji.style.display = 'block';
    });
    
  cel.classList.add('active');

  setTimeout(() => speakWord(item.w), 300);

  const r = document.getElementById('star-count').getBoundingClientRect();
  addStar(r.left, r.top);

  setTimeout(() => {
    cel.classList.remove('active');
    wordIdx++;
    loadWord();
  }, 2200);
}

// ====== KEYBOARD INPUT (unchanged) ======
document.addEventListener('keydown', (e) => {
  if (!document.getElementById('game').classList.contains('active')) return;
  const k = e.key.toLowerCase();
  if (k.length === 1 && k >= 'a' && k <= 'z') {
    e.preventDefault();
    handleKey(k);
  }
});

document.addEventListener('dblclick', e => e.preventDefault());
</script>
</body>
</html>